// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // uses connection pooling
  directUrl = env("POSTGRES_URL_NON_POOLING") // uses a direct connection
}

model User {
  id            Int            @id @default(autoincrement())
  firstName     String         @default("")
  lastName      String         @default("")
  username      String?        @unique
  password      String
  profileImage  String?        @default("")
  email         String         @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  accountStatus String         @default("active")
  pitch         String?
  lookingFor    String?
  resume        Resume[]
  positions     JobPosition[]
  achievements  Achievement[]
  projects      Project[]
  education     Education[]
  subscriptions Subscription[]
}

model Plan {
  id            String         @id @default(uuid())
  key           String
  level         Int // e.g., Free: 0, Pro: 1
  name          String
  priceCents    Int // e.g. 0 for Free, 1000 for $10
  interval      String // 'month', 'year'
  features      String[] // Optional
  subscriptions Subscription[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Subscription {
  id               String    @id @default(uuid())
  userID           Int
  planID           String
  status           String    @default("trial")
  stripeCustomerId String? // optional, for Stripe integration
  stripeSubId      String? // Stripe subscription ID
  trialEndsAt      DateTime?
  currentPeriodEnd DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userID], references: [id])
  plan Plan @relation(fields: [planID], references: [id])

  events SubscriptionEvent[]
}

model SubscriptionEvent {
  id             String              @id @default(uuid())
  subscriptionID String
  eventType      String              @default("created") // e.g., 'created', 'updated', 'canceled'
  fromStatus     SubscriptionStatus?
  toStatus       SubscriptionStatus?
  metadata       Json? // Additional event data
  createdAt      DateTime            @default(now())

  subscription Subscription @relation(fields: [subscriptionID], references: [id], onDelete: Cascade)

  @@map("subscription_events")
}

model Resume {
  id          String       @id @default(uuid())
  name        String?
  userID      Int
  user        User         @relation(fields: [userID], references: [id])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  default     Boolean      @default(false)
  firstName   String       @default("")
  lastName    String       @default("")
  email       String       @default("")
  summary     String       @default("")
  phoneNumber String       @default("")
  location    String       @default("")
  website     String       @default("")
  linkedin    String       @default("")
  github      String       @default("")
  title       String?
  positions   JobOptions[]
}

model JobOptions {
  id                  String        @id @default(uuid())
  resumeID            String?
  resume              Resume?       @relation(fields: [resumeID], references: [id])
  jobID               String?
  job                 JobPosition?  @relation(fields: [jobID], references: [id])
  jobOverwrites       Json?
  visibleAchievements Achievement[] @relation("visibleAchievements")
}

model JobPosition {
  id              String        @id @default(uuid())
  userID          Int
  user            User          @relation(fields: [userID], references: [id])
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  name            String        @default("")
  description     String        @default("")
  startDate       DateTime?
  endDate         DateTime?
  currentPosition Boolean       @default(false)
  company         String        @default("")
  location        String        @default("")
  achievements    Achievement[]
  projects        Project[]
  jobOptions      JobOptions[]
}

model Achievement {
  id              String       @id @default(uuid())
  userID          Int
  user            User         @relation(fields: [userID], references: [id])
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  name            String?      @default("")
  description     String
  goal            String?
  result          String?
  metrics         String?
  myContribution  String?
  projectID       String?
  visibleOnResume Boolean?     @default(true)
  project         Project?     @relation(fields: [projectID], references: [id])
  jobPositionID   String?
  jobPosition     JobPosition? @relation(fields: [jobPositionID], references: [id])
  educationID     String?
  education       Education?   @relation(fields: [educationID], references: [id])
  resumePosition  JobOptions[] @relation("visibleAchievements")
}

model Project {
  id            String        @id @default(uuid())
  userID        Int
  user          User          @relation(fields: [userID], references: [id])
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  jobPositionID String
  jobPosition   JobPosition   @relation(fields: [jobPositionID], references: [id])
  description   String
  achievements  Achievement[]
}

model Education {
  id              String        @id @default(uuid())
  userID          Int
  user            User          @relation(fields: [userID], references: [id])
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  institution     String        @default("")
  degree          String        @default("")
  description     String        @default("")
  startDate       DateTime?
  endDate         DateTime?
  currentPosition Boolean       @default(false)
  achievements    Achievement[]
}

// Optional: Store webhook events for debugging
model WebhookEvent {
  id        String   @id @default(uuid())
  stripeId  String   @unique // Stripe event ID
  eventType String // e.g., 'customer.subscription.updated'
  processed Boolean  @default(false)
  data      Json // Raw webhook data
  createdAt DateTime @default(now())

  @@map("webhook_events")
}
